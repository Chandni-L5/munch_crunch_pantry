<div id="reviews-section"></div>

<div class="container my-4 px-3 reviews-wrap">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="row g-4">

                <!-- Reviews list -->
                <div class="col-12 col-lg-8">
                    <div class="review-card h-100">
                        <div class="review-card-header">
                            <h3 class="logo-font">
                                <span class="pill">
                                    <i class="far fa-comments"></i>
                                    <span id="review-count">{{ product.rating_count }}</span>
                                </span>
                                Reviews
                            </h3>
                        </div>

                        <div class="review-card-body">
                            {% for r in all_reviews %}
                            <div class="review-content
                                    {% if not r.is_approved and r.user == user %}
                                        faded
                                    {% elif not r.is_approved %}
                                        d-none
                                    {% endif %}
                                ">
                                <div class="review-details">
                                    <strong>{{ r.user.username }}</strong>
                                    <span class="dot">·</span>
                                    <span class="small text-muted">{{ r.created_at|date:"d M Y" }}</span>
                                </div>

                                <div class="rating-stars text-warning mb-2">
                                    {% for i in "12345" %}
                                    {% if forloop.counter <= r.rating %}
                                    ★
                                    {% else %}
                                    ☆
                                    {% endif %}
                                    {% endfor %}
                                </div>

                                <div id="review{{ r.id }}">
                                    {{ r.comment|linebreaks }}
                                </div>

                                {% if not r.is_approved and r.user == user %}
                                <div class="review-approval">
                                    Your review is awaiting approval by admin.
                                </div>
                                {% endif %}
                            </div>
                            {% empty %}
                            <p class="text-muted mb-0">
                                This product has not been reviewed yet.
                            </p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Form / actions -->
                <div class="col-12 col-lg-4">
                    <div class="review-card h-100">
                        <div class="review-card-header">
                            <h3 class="logo-font mb-0">Your review</h3>
                        </div>

                        <div class="review-card-body">
                            {% if user.is_authenticated %}
                            {% if has_purchased %}

                            {% if can_create %}
                            <p class="mb-2 text-muted">Posting as: <strong>{{ user.username }}</strong></p>

                            <form id="reviewCreateForm" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="create_review">

                                <div class="mb-2">
                                    <label class="form-label d-block mb-1">Your rating</label>
                                    <div class="star-rating">
                                        {% for i in "12345" %}
                                        <span class="star text-warning" data-value="{{ i }}">☆</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                {{ review_form.rating }}
                                {{ review_form.comment|as_crispy_field }}
                                <p class="form-text text-muted comment-helper" aria-live="polite">
                                    Write a comment to enable submit.
                                </p>

                                <div class="text-center mt-3">
                                    <button type="submit" class="btn-lg submit-btn review-scroll-btn" disabled>
                                        Submit
                                    </button>
                                </div>
                            </form>

                            {% elif user_review and editing %}
                            <p class="mb-2 text-muted">Editing as: <strong>{{ user.username }}</strong></p>

                            <form id="reviewEditForm" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="update_review">

                                <div class="mb-2">
                                    <label class="form-label d-block mb-1">Your rating</label>
                                    <div class="star-rating">
                                        {% for i in "12345" %}
                                        <span class="star text-warning" data-value="{{ i }}">☆</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                {{ review_form.rating }}
                                {{ review_form.comment|as_crispy_field }}
                                <p class="form-text text-muted comment-helper" aria-live="polite">
                                    Write a comment to enable submit.
                                </p>
                                <div class="d-flex justify-content-end gap-2 mt-3 review-actions">
                                    <a class="btn btn-outline-dark btn-sm review-scroll-btn"
                                        href="{% url 'product_detail' product.id %}#reviews-section">
                                        Cancel
                                    </a>
                                    <button class="btn btn-outline-warning btn-sm review-scroll-btn" type="submit"
                                        disabled>
                                        Save changes
                                    </button>
                                </div>
                            </form>

                            {% elif user_review %}
                            <p class="text-muted mb-2">
                                You’ve already reviewed this product.
                            </p>

                            <div class="d-flex flex-wrap gap-2 review-actions">
                                <a class="btn btn-outline-dark btn-sm review-scroll-btn"
                                    href="{% url 'product_detail' product.slug %}?edit_review=1#reviews-section">
                                    Edit
                                </a>

                                <button type="button" class="btn btn-outline-danger btn-sm review-scroll-btn"
                                    data-bs-toggle="modal" data-bs-target="#deleteReviewModal">
                                    Delete
                                </button>
                            </div>

                            <div class="modal fade" id="deleteReviewModal" tabindex="-1"
                                aria-labelledby="deleteReviewModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="deleteReviewModalLabel">Delete review?</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                                aria-label="Close"></button>
                                        </div>

                                        <div class="modal-body">
                                            <p class="mb-2">
                                                Are you sure you want to delete your review? This can’t be undone.
                                            </p>

                                            <div class="border rounded p-2 bg-light">
                                                <div class="small text-muted mb-1">
                                                    Rating: {{ user_review.rating }}/5
                                                </div>
                                                <div class="small">
                                                    {{ user_review.comment|truncatechars:140 }}
                                                </div>
                                            </div>
                                        </div>

                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-outline-dark btn-sm review-scroll-btn"
                                                data-bs-dismiss="modal">
                                                Cancel
                                            </button>

                                            <form method="post" class="d-inline">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="delete_review">
                                                <button class="btn btn-outline-danger btn-sm review-scroll-btn"
                                                    type="submit">
                                                    Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% endif %}

                            {% else %}
                            <p class="text-center mb-0">
                                You can only review products you’ve purchased.
                            </p>
                            {% endif %}
                            {% else %}
                            <p class="text-center mb-0">
                                <a href="{% url 'account_login' %}">Log in</a> to leave a review.
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>