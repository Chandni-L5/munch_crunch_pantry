let stripe,card,clientSecret,isProcessing=!1,cardComplete=!1,cardError=null;function isFormValid(){return[document.getElementById("id_full_name"),document.getElementById("id_email"),document.getElementById("id_phone_number"),document.getElementById("id_street_address1"),document.getElementById("id_town_or_city"),document.getElementById("id_postcode")].every((e=>e&&""!==e.value.trim()))}function updateSubmitState(){const e=document.getElementById("submit");if(!e)return;const t=isFormValid()&&cardComplete&&!cardError&&!isProcessing;e.disabled=!t}function getFriendlyStripeErrorMessage(e){if(!e)return"Something went wrong while processing your payment. Please try again.";const t=e.code||"",n=e.decline_code||"",r=e.payment_intent&&e.payment_intent.status;if("authentication_required"===t||"payment_intent_authentication_failure"===t||"authentication_required"===n||"requires_action"===r)return"We couldn’t verify your payment with your bank. Please try again and complete the security check.";return["card_declined","insufficient_funds","do_not_honor","generic_decline"].includes(t)||n&&"authentication_required"!==n||"requires_payment_method"===r?"Your bank declined this card. Please use a different card or contact your bank.":"validation_error"===e.type?e.message||"There’s a problem with the details you entered. Please check and try again.":"We’re having trouble processing payments right now. Your card hasn’t been charged. Please try again in a few minutes."}async function handleSubmit(e){if(e.preventDefault(),isProcessing)return;isProcessing=!0,setLoading(!0);const t=document.getElementById("id_full_name"),n=document.getElementById("id_email"),r=document.getElementById("id_phone_number"),o=document.getElementById("id_street_address1"),i=document.getElementById("id_street_address2"),a=document.getElementById("id_town_or_city"),d=document.getElementById("id_postcode"),s=document.getElementById("id_country"),c=s&&s.value?s.value:"GB",l={name:t.value.trim(),email:n.value.trim(),phone:r.value.trim(),address:{line1:o.value.trim(),line2:i.value.trim(),city:a.value.trim(),postal_code:d.value.trim(),country:c}},m={name:t.value.trim(),phone:r.value.trim(),address:{line1:o.value.trim(),line2:i.value.trim(),city:a.value.trim(),postal_code:d.value.trim(),country:c}},u=document.getElementById("id-save-info"),y=!!u&&u.checked,g=document.querySelector('input[name="csrfmiddlewaretoken"]').value;try{const e=await fetch("/checkout/cache_checkout_data/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":g},body:JSON.stringify({client_secret:clientSecret,save_info:y})}),t=await e.json();if(!e.ok)return showError(t.error||"We couldn't process your payment. Please try again."),void resetProcessingState()}catch(h){return showError("We couldn't process your payment. Please try again."),void resetProcessingState()}let p;toggleFormDisabled(!0),card&&card.update({disabled:!0});try{p=await stripe.confirmCardPayment(clientSecret,{payment_method:{card:card,billing_details:l},shipping:m})}catch(e){return showError("There was a problem confirming your payment. Please try again."),void resetProcessingState()}const{error:h,paymentIntent:_}=p;if(h){return showError(getFriendlyStripeErrorMessage(h)),void resetProcessingState()}if(_&&"succeeded"===_.status){toggleFormDisabled(!1);const e=document.getElementById("payment-form");HTMLFormElement.prototype.submit.call(e)}else showError("Payment did not complete. Please try again."),resetProcessingState()}function showError(e){const t=document.querySelector("#error-message");t.textContent=e,setTimeout((function(){t.textContent=""}),1e4)}function setLoading(e){const t=document.getElementById("submit");if(!t)return;const n=document.getElementById("button-spinner"),r=t.querySelector(".btn-content");e?(t.disabled=!0,r&&(r.style.opacity="0"),n&&n.classList.remove("hidden")):(t.disabled=!1,r&&(r.style.opacity="1"),n&&n.classList.add("hidden"))}function toggleFormDisabled(e){document.getElementById("payment-form").querySelectorAll("input, select, button, textarea").forEach((t=>{"csrfmiddlewaretoken"!==t.name&&"submit"!==t.id&&(t.disabled=e)}))}function resetProcessingState(){setLoading(!1),toggleFormDisabled(!1),card&&card.update({disabled:!1}),isProcessing=!1}document.addEventListener("DOMContentLoaded",(async()=>{stripe=Stripe(STRIPE_PUBLIC_KEY);const e=await fetch("/checkout/create-payment-intent/",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}),t=await e.json();if(t.error)return void showError(t.error);clientSecret=t.clientSecret;const n=document.getElementById("id_client_secret");n&&(n.value=clientSecret);const r=stripe.elements();card=r.create("card",{style:{base:{color:"var(--color-3)",fontFamily:"var(--font-family-1)",fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"var(--color-10)"},":-webkit-autofill":{color:"var(--color-3)"}},invalid:{color:"#e5424d",iconColor:"#e5424d"}},hidePostalCode:!0}),card.mount("#card-element"),card.on("change",(function(e){const t=document.getElementById("error-message");e.error?(t.textContent=e.error.message,cardError=e.error.message):(t.textContent="",cardError=null),cardComplete=!0===e.complete,updateSubmitState()}));const o=document.getElementById("payment-form");o&&o.addEventListener("submit",handleSubmit);const i=document.getElementById("submit");i&&(i.disabled=!0);["id_full_name","id_email","id_phone_number","id_street_address1","id_town_or_city","id_postcode"].forEach((e=>{const t=document.getElementById(e);if(!t)return;const n="SELECT"===t.tagName?"change":"input";t.addEventListener(n,updateSubmitState)}))})),document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll("input.form-control").forEach((e=>{if("card-element"===e.id)return;const t=document.createElement("div");function n(){const n=e.value.trim();if(""===n)return e.classList.remove("is-invalid"),void(t.style.display="none");let r=!0;if("email"===e.type&&(r=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n),r||(t.textContent="Please enter a valid email address.")),"id_phone_number"===e.id){const e=n.replace(/\D/g,"");r=e.length>=7&&e.length<=15,r||(t.textContent="Please enter a valid phone number.")}r?(e.classList.remove("is-invalid"),t.style.display="none"):(e.classList.add("is-invalid"),t.style.display="block")}t.classList.add("invalid-feedback"),t.style.display="none",t.textContent="This field is required.",e.parentNode.appendChild(t),["input","blur","change"].forEach((t=>e.addEventListener(t,n))),n()}))}));